# RTSP服务器架构图

## 整体架构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           RTSP服务器整体架构                                │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              主程序层 (Main)                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    RtspServer.cc                                   │   │
│  │  - 创建 MultiThreadEventLoop (4个工作线程)                         │   │
│  │  - 启动服务器                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          多线程事件循环层 (MultiThreadEventLoop)            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  主线程 (Main Thread)                                              │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  EventLoop (主EventLoop)                                    │   │   │
│  │  │  - 监听新连接 (Acceptor)                                     │   │   │
│  │  │  - 分配连接给工作线程                                        │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                       │
│  ┌─────────────────────────────────┼─────────────────────────────────────┐ │
│  │                                 │                                     │ │
│  ▼                                 ▼                                     ▼ │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │ │
│  │  工作线程1      │  │  工作线程2      │  │  工作线程3      │            │ │
│  │  EventLoop      │  │  EventLoop      │  │  EventLoop      │            │ │
│  │  - 处理RTSP连接 │  │  - 处理RTSP连接 │  │  - 处理RTSP连接 │            │ │
│  │  - 管理会话     │  │  - 管理会话     │  │  - 管理会话     │            │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │ │
│                                                                           │ │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │ │
│  │  工作线程4      │  │  线程池         │  │  连接分配器     │            │ │
│  │  EventLoop      │  │  ThreadPool     │  │  getNextLoop()  │            │ │
│  │  - 处理RTSP连接 │  │  - 管理线程     │  │  - 轮询分配     │            │ │
│  │  - 管理会话     │  │  - 任务调度     │  │  - 负载均衡     │            │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘            │ │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            RTSP连接处理层 (RtspConnect)                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  每个连接一个 RtspConnect 实例                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  RTSP协议处理                                               │   │   │
│  │  │  - OPTIONS: 获取服务器能力                                   │   │   │
│  │  │  - DESCRIBE: 获取媒体描述                                    │   │   │
│  │  │  - SETUP: 建立传输通道                                       │   │   │
│  │  │  - PLAY: 开始播放                                            │   │   │
│  │  │  - TEARDOWN: 结束会话                                        │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            会话管理层 (Session Management)                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  全局共享会话池 (静态变量)                                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  _sessionMap (unordered_map<string, RtspSession>)          │   │   │
│  │  │  ┌─────────────────────────────────────────────────────┐   │   │   │
│  │  │  │  Session1: {sessionId, clientIP, isPlaying, ...}    │   │   │   │
│  │  │  │  Session2: {sessionId, clientIP, isPlaying, ...}    │   │   │   │
│  │  │  │  Session3: {sessionId, clientIP, isPlaying, ...}    │   │   │   │
│  │  │  └─────────────────────────────────────────────────────┘   │   │   │
│  │  │  _sessionMutex (保护会话池的互斥锁)                        │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            媒体传输层 (Media Transport)                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  RTP推送器 (RtpPusher)                                            │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  UDP传输模式                                                │   │   │
│  │  │  ┌─────────────────────────────────────────────────────┐   │   │   │
│  │  │  │  _videoRtpConn (UdpConnection)                      │   │   │   │
│  │  │  │  _videoRtcpConn (UdpConnection)                     │   │   │   │
│  │  │  │  _audioRtpConn (UdpConnection)                      │   │   │   │
│  │  │  │  _audioRtcpConn (UdpConnection)                     │   │   │   │
│  │  │  └─────────────────────────────────────────────────────┘   │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  TCP传输模式                                                │   │   │
│  │  │  ┌─────────────────────────────────────────────────────┐   │   │   │
│  │  │  │  _connPtr (TcpConnection)                           │   │   │   │
│  │  │  │  - 复用TCP连接传输RTP包                              │   │   │   │
│  │  │  └─────────────────────────────────────────────────────┘   │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            媒体源层 (Media Source)                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  文件读取器                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  H264FileReader                                             │   │   │
│  │  │  - 读取H.264视频文件                                        │   │   │
│  │  │  - 解析NALU单元                                             │   │   │
│  │  │  - 生成RTP包                                               │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │  AacFileReader                                              │   │   │
│  │  │  - 读取AAC音频文件                                          │   │   │
│  │  │  - 解析音频帧                                               │   │   │
│  │  │  - 生成RTP包                                               │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 线程模型详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              线程模型                                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  主线程 (Main Thread)                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  EventLoop::loop()                                                  │   │
│  │  ├── epoll_wait() 监听新连接                                        │   │
│  │  ├── onNewConnection() 接受新连接                                    │   │
│  │  ├── getNextLoop() 选择工作线程                                      │   │
│  │  └── 分配连接给工作线程                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│  工作线程池 (Worker Thread Pool)                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  工作线程1                   工作线程2                   工作线程3   │   │
│  │  ┌─────────────────────┐  ┌─────────────────────┐  ┌─────────────────┐ │
│  │  │  EventLoop::loop()  │  │  EventLoop::loop()  │  │  EventLoop::loop()│ │
│  │  │  ├── epoll_wait()   │  │  ├── epoll_wait()   │  │  ├── epoll_wait() │ │
│  │  │  ├── onMessage()    │  │  ├── onMessage()    │  │  ├── onMessage()  │ │
│  │  │  ├── handleRtsp()   │  │  ├── handleRtsp()   │  │  ├── handleRtsp() │ │
│  │  │  └── RTP推送        │  │  └── RTP推送        │  │  └── RTP推送      │ │
│  │  └─────────────────────┘  └─────────────────────┘  └─────────────────┘ │
│  │                                                                         │ │
│  │  工作线程4                                                             │ │
│  │  ┌─────────────────────┐                                               │ │
│  │  │  EventLoop::loop()  │                                               │ │
│  │  │  ├── epoll_wait()   │                                               │ │
│  │  │  ├── onMessage()    │                                               │ │
│  │  │  ├── handleRtsp()   │                                               │ │
│  │  │  └── RTP推送        │                                               │ │
│  │  └─────────────────────┘                                               │ │
│  └─────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 数据流图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              RTSP数据流                                     │
└─────────────────────────────────────────────────────────────────────────────┘

客户端请求流程:
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   客户端    │───▶│   主线程    │───▶│  工作线程   │───▶│  RtspConnect│
│             │    │  (Acceptor) │    │  (EventLoop)│    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                              │
                                                              ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   客户端    │◀───│   主线程    │◀───│  工作线程   │◀───│  响应生成   │
│             │    │  (Acceptor) │    │  (EventLoop)│    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘

媒体流推送流程:
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  H264文件   │───▶│ H264Reader  │───▶│ RtpPusher   │───▶│ UDP/TCP连接 │
│             │    │             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                                                              │
┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│  AAC文件    │───▶│ AACReader   │───▶│ RtpPusher   │────────┘
│             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘
                                                              │
                                                              ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   客户端    │◀───│   网络      │◀───│   RTP包     │◀───│  媒体流     │
│             │    │             │    │             │    │             │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 关键组件关系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            组件依赖关系                                     │
└─────────────────────────────────────────────────────────────────────────────┘

MultiThreadEventLoop
├── EventLoop (主线程)
│   ├── Acceptor (监听连接)
│   └── 连接分配器
├── EventLoop[] (工作线程数组)
│   ├── TcpConnection (TCP连接管理)
│   ├── UdpConnection (UDP连接管理)
│   └── RtspConnect (RTSP协议处理)
└── ThreadPool (线程池管理)

RtspConnect
├── 静态共享资源
│   ├── _sessionMap (会话池)
│   └── _sessionMutex (互斥锁)
├── 媒体处理
│   ├── H264FileReader (视频源)
│   ├── AacFileReader (音频源)
│   └── RtpPusher (RTP推送器)
└── 传输连接
    ├── TcpConnection (TCP传输)
    └── UdpConnection[] (UDP传输)

RtpPusher
├── 媒体源
│   ├── H264FileReader
│   └── AacFileReader
├── 传输层
│   ├── TcpConnection (TCP模式)
│   └── UdpConnection[] (UDP模式)
└── RTP封装
    ├── 视频RTP包
    └── 音频RTP包
```

## 并发控制机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            并发控制机制                                     │
└─────────────────────────────────────────────────────────────────────────────┘

1. 线程级并发控制:
   ┌─────────────────────────────────────────────────────────────────────┐
   │  主线程: 只负责接受新连接，不处理具体业务                           │
   │  工作线程: 每个线程独立处理分配的连接，互不干扰                     │
   │  线程池: 管理工作线程的生命周期                                     │
   └─────────────────────────────────────────────────────────────────────┘

2. 会话级并发控制:
   ┌─────────────────────────────────────────────────────────────────────┐
   │  _sessionMutex: 保护全局会话池的互斥锁                              │
   │  ├── 创建会话时加锁                                                │
   │  ├── 查找会话时加锁                                                │
   │  ├── 修改会话时加锁                                                │
   │  └── 删除会话时加锁                                                │
   └─────────────────────────────────────────────────────────────────────┘

3. 连接级并发控制:
   ┌─────────────────────────────────────────────────────────────────────┐
   │  EventLoop::assertInLoopThread(): 确保操作在正确的线程中执行        │
   │  ├── 每个连接只能在分配的EventLoop线程中操作                       │
   │  ├── 防止跨线程访问连接对象                                        │
   │  └── 保证线程安全                                                  │
   └─────────────────────────────────────────────────────────────────────┘

4. 端口分配并发控制:
   ┌─────────────────────────────────────────────────────────────────────┐
   │  portMutex: 保护UDP端口分配的互斥锁                                 │
   │  ├── allocateUdpPorts(): 分配端口时加锁                            │
   │  ├── 使用原子操作 nextUdpPort.fetch_add()                          │
   │  └── 确保端口不冲突                                                │
   └─────────────────────────────────────────────────────────────────────┘
```

## 性能特点

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            性能特点                                         │
└─────────────────────────────────────────────────────────────────────────────┘

1. 高并发处理:
   - 主线程 + 4个工作线程的架构
   - 每个工作线程独立处理多个连接
   - 支持大量并发客户端

2. 高效I/O:
   - 基于epoll的事件驱动模型
   - 非阻塞I/O操作
   - 减少线程切换开销

3. 负载均衡:
   - 轮询方式分配连接给工作线程
   - 避免单个线程过载
   - 充分利用多核CPU

4. 内存管理:
   - 智能指针管理对象生命周期
   - 及时释放不需要的资源
   - 避免内存泄漏

5. 网络优化:
   - 支持TCP和UDP两种传输模式
   - UDP模式减少网络开销
   - TCP模式保证传输可靠性
``` 