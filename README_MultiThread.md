# 多线程RTSP服务器

## 概述

这是一个基于多线程IO模型的RTSP服务器，采用One Loop Per Thread + ThreadPool的架构设计。

## 架构设计

### 1. One Loop Per Thread 模式
- **主线程**：运行主EventLoop，负责接受新连接
- **工作线程**：每个线程运行一个EventLoop，处理分配给它的连接
- **连接分配**：新连接通过轮询方式分配给工作线程

### 2. 线程池
- **EventLoop线程池**：处理网络IO事件
- **工作线程池**：处理业务逻辑（如RTSP协议解析、媒体数据处理等）

### 3. 线程安全
- 使用互斥锁保护共享资源
- 跨线程调用通过Eventor机制实现
- 连接管理采用线程安全的方式

## 编译和运行

### 编译
```bash
make clean
make
```

### 运行
```bash
./rtsp_server_mt
```

### 调试版本
```bash
make debug
```

## 配置参数

在 `TestMultiThreadServer.cc` 中可以调整以下参数：

```cpp
// 创建多线程服务器
// 参数：IP, 端口, EventLoop线程数, 工作线程数, 队列大小
g_server = std::make_unique<MultiThreadTcpServer>("0.0.0.0", 8554, 4, 8, 1000);
```

- **IP**: 服务器监听地址
- **端口**: 服务器监听端口
- **EventLoop线程数**: 处理网络IO的线程数（建议设置为CPU核心数）
- **工作线程数**: 处理业务逻辑的线程数
- **队列大小**: 任务队列的最大容量

## 性能优化建议

### 1. 线程数配置
- EventLoop线程数建议设置为CPU核心数
- 工作线程数可以根据业务复杂度调整
- 避免创建过多线程，以免造成上下文切换开销

### 2. 连接分配策略
当前使用轮询方式分配连接，可以根据需要实现更智能的分配策略：
- 基于连接数的负载均衡
- 基于CPU使用率的动态分配
- 基于连接类型的分类分配

### 3. 内存管理
- 使用智能指针管理对象生命周期
- 避免频繁的内存分配和释放
- 考虑使用内存池优化小对象分配

## 监控和调试

### 1. 日志输出
服务器会输出以下信息：
- 连接建立和断开
- 线程启动和停止
- 错误信息

### 2. 性能监控
可以通过以下方式监控性能：
- 使用 `top` 命令查看CPU使用率
- 使用 `netstat` 查看连接数
- 使用 `strace` 跟踪系统调用

## 扩展功能

### 1. 添加新的协议支持
1. 继承 `TcpConnection` 类
2. 实现协议解析逻辑
3. 在 `MultiThreadEventLoop` 中注册回调

### 2. 添加负载均衡
1. 实现自定义的连接分配策略
2. 添加健康检查机制
3. 实现动态负载调整

### 3. 添加监控和统计
1. 添加连接数统计
2. 添加吞吐量监控
3. 添加延迟统计

## 注意事项

1. **线程安全**：确保所有跨线程访问都使用适当的同步机制
2. **资源管理**：及时释放不再使用的资源
3. **错误处理**：妥善处理各种异常情况
4. **性能测试**：在生产环境部署前进行充分的性能测试

## 故障排除

### 1. 编译错误
- 确保使用C++17或更高版本
- 检查所有依赖库是否正确安装

### 2. 运行时错误
- 检查端口是否被占用
- 检查文件权限
- 查看错误日志

### 3. 性能问题
- 调整线程数配置
- 检查系统资源使用情况
- 优化业务逻辑 